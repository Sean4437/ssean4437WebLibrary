<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>工程白板拍照工具</title>
    <style>
      :root {
        font-family: "Noto Sans TC", "Segoe UI", system-ui, -apple-system,
          BlinkMacSystemFont, sans-serif;
        line-height: 1.45;
        color: #0f172a;
        background: #0f172a;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 1.25rem;
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 150px);
        background: radial-gradient(circle, #1e293b, #0f172a);
        display: flex;
        justify-content: center;
      }

      .app-shell {
        width: min(560px, 100%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      h1 {
        color: #f8fafc;
        text-align: center;
        margin: 0;
        font-size: clamp(1.4rem, 5vw, 2.1rem);
        letter-spacing: 0.08em;
      }

      .version-note {
        text-align: center;
        color: #facc15;
        font-size: 0.95rem;
        margin-top: 0.3rem;
        font-weight: 600;
      }

      .panel {
        background: rgba(15, 23, 42, 0.45);
        border-radius: 20px;
        padding: 1rem 1.1rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: #e2e8f0;
        backdrop-filter: blur(12px);
      }

      .panel h3 {
        margin: 0 0 0.75rem;
        font-size: 1.05rem;
        letter-spacing: 0.05em;
      }

      .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
      }

      .form-field {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .form-field label {
        font-size: 0.9rem;
      }

      .form-field input,
      .form-field textarea {
        border-radius: 12px;
        border: 1px solid rgba(226, 232, 240, 0.35);
        background: rgba(15, 23, 42, 0.6);
        color: #f8fafc;
        font: inherit;
        padding: 0.55rem 0.7rem;
      }

      .form-field textarea {
        min-height: 90px;
        resize: none;
        overflow: hidden;
      }

      .panel-hint {
        margin-top: 0.4rem;
        font-size: 0.83rem;
        color: #cbd5f5;
      }

      .panel-actions {
        margin-top: 0.8rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
        align-items: center;
      }

      .panel-control {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }

      .panel-control input[type="range"] {
        flex: 1;
      }

      .ghost-btn {
        border-radius: 999px;
        border: 1px solid rgba(226, 232, 240, 0.45);
        background: transparent;
        color: #e2e8f0;
        font-weight: 600;
        padding: 0.6rem 1.25rem;
        cursor: pointer;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.1rem;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        box-shadow: 0 10px 18px rgba(37, 99, 235, 0.3);
      }

      .btn-secondary {
        background: transparent;
        border: 2px solid #94a3b8;
        color: #e2e8f0;
        box-shadow: none;
      }

      .stage {
        position: relative;
        width: 100%;
        border-radius: 24px;
        overflow: hidden;
        background: #0f172a;
        box-shadow: 0 25px 55px rgba(0, 0, 0, 0.45);
        border: 6px solid rgba(248, 250, 252, 0.1);
        --stage-aspect: 56.25%;
      }

      .stage.exporting {
        background: transparent;
        box-shadow: none;
        border-color: transparent;
      }

      .stage::before {
        content: "";
        display: block;
        padding-top: var(--stage-aspect);
      }

      .stage-content {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #0f172a;
      }

      .stage-content.exporting {
        background: transparent;
      }

      .stage-content img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .stage-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        text-align: center;
        color: #cbd5f5;
      }

      .whiteboard-wrapper {
        --board-scale: 0.85;
        position: absolute;
        left: 50%;
        top: 70%;
        transform: translate(-50%, -50%) scale(var(--board-scale));
        transform-origin: center;
        width: min(480px, 90%);
        touch-action: none;
      }

      .whiteboard {
        width: 100%;
        background: rgba(248, 250, 252, 0.96);
        border-radius: 18px;
        border: 4px solid #cbd5f5;
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.35);
        padding: 0.9rem;
      }

      .whiteboard.exporting {
        box-shadow: none;
      }

      .whiteboard-content {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .board-row {
        display: flex;
        align-items: center;
        gap: 0.45rem;
      }

      .board-row label {
        flex: 0 0 72px;
        font-size: 0.9rem;
        letter-spacing: 0.04em;
      }

      .board-value {
        flex: 1;
        min-height: 34px;
        border: 1px solid #cbd5f5;
        border-radius: 10px;
        padding: 0.35rem 0.55rem;
        background: #fff;
        font-size: 0.96rem;
        font-weight: 600;
        color: #0f172a;
        white-space: pre-wrap;
      }

      .board-block {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .board-block label {
        font-size: 0.88rem;
        letter-spacing: 0.04em;
      }

      .board-notes {
        min-height: 3.2rem;
        border: 1px solid #cbd5f5;
        border-radius: 14px;
        padding: 0.65rem 0.75rem;
        background: #fff;
        font-size: 1rem;
        line-height: 1.4;
        white-space: pre-wrap;
      }

      .signature-placeholder-box {
        flex: 1;
        min-height: 80px;
        border: 1px dashed #cbd5f5;
        border-radius: 12px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 0.95rem;
      }

      .action-bar {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
        left: 50%;
        transform: translateX(-50%);
        width: min(520px, calc(100% - 1.5rem));
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem;
        padding: 0.85rem 1rem;
        border-radius: 24px;
        background: rgba(15, 23, 42, 0.85);
        box-shadow: 0 20px 35px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(12px);
      }

      .action-btn {
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.25rem;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
      }

      .action-btn.primary {
        background: linear-gradient(135deg, #059669, #10b981);
        color: #fff;
      }

      .action-btn.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .toast-message {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 90px);
        left: 50%;
        transform: translateX(-50%);
        width: min(520px, calc(100% - 1.5rem));
        padding: 0.75rem 1rem;
        border-radius: 16px;
        background: rgba(15, 23, 42, 0.9);
        color: #f8fafc;
        text-align: center;
        font-size: 0.95rem;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .toast-message.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(-8px);
      }

      .toast-message[data-variant="success"] {
        background: rgba(34, 197, 94, 0.9);
        color: #052e13;
      }

      .hidden-input {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div>
        <h1>工程白板拍照工具</h1>
        <p class="version-note">⚠ 已更新版本 v2.0，請使用此介面最新版功能</p>
      </div>

      <section class="panel">
        <h3>資料輸入面板</h3>
        <div class="data-grid">
          <div class="form-field">
            <label for="inputProjectName">工程名稱</label>
            <input id="inputProjectName" type="text" placeholder="請輸入工程名稱" />
          </div>
          <div class="form-field">
            <label for="inputInspectionLocation">檢查位置</label>
            <input id="inputInspectionLocation" type="text" placeholder="請輸入檢查位置" />
          </div>
          <div class="form-field">
            <label for="inputTestDate">檢查日期</label>
            <input id="inputTestDate" type="date" />
          </div>
          <div class="form-field" style="grid-column: 1 / -1">
            <label for="inputTestResult">檢查紀錄</label>
            <textarea id="inputTestResult" placeholder="寫下檢查內容、測量結果等"></textarea>
          </div>
        </div>
        <div class="panel-hint">輸入完畢後按下「套用到白板」。</div>
        <div class="panel-actions">
          <label class="panel-control">
            <span>白板尺寸</span>
            <input type="range" id="boardScale" min="10" max="120" value="85" />
            <span id="boardScaleValue">85%</span>
          </label>
          <label class="panel-control">
            <span>白板顏色</span>
            <input type="color" id="boardColor" value="#f8fafc" />
          </label>
          <label class="panel-control">
            <span>透明度</span>
            <input type="range" id="boardOpacity" min="70" max="100" value="96" />
            <span id="boardOpacityValue">96%</span>
          </label>
          <label class="panel-control">
            <span>文字顏色</span>
            <input type="color" id="textColor" value="#0f172a" />
          </label>
          <button type="button" class="ghost-btn" id="applyDataBtn">套用到白板</button>
        </div>
      </section>

      <div class="controls">
        <button class="btn" id="takePhotoBtn">拍照</button>
        <button class="btn btn-secondary" id="uploadPhotoBtn">上傳照片</button>
      </div>

      <div class="stage" id="captureArea">
        <div class="stage-content" id="photoLayer">
          <img id="photoImage" alt="拍攝預覽" hidden />
          <div class="stage-placeholder" id="placeholder">
            <strong>請拍照或上傳照片</strong>
            <span>白板會顯示在畫面上，可拖曳與縮放。</span>
          </div>
        </div>
        <div class="whiteboard-wrapper" id="whiteboardWrapper">
          <div class="whiteboard" id="whiteboard">
            <div class="whiteboard-content">
              <div class="board-row">
                <label>工程名稱</label>
                <div class="board-value" id="displayProjectName">—</div>
              </div>
              <div class="board-row">
                <label>檢查位置</label>
                <div class="board-value" id="displayInspectionLocation">—</div>
              </div>
              <div class="board-block">
                <label>檢查紀錄</label>
                <div class="board-notes" id="displayTestResult">—</div>
              </div>
              <div class="board-row">
                <label>檢查日期</label>
                <div class="board-value" id="displayTestDate">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="action-btn secondary" id="clearBoardBtn">清除白板</button>
        <button class="action-btn primary" id="exportBtn">匯出整張圖片</button>
      </div>

      <p id="toastMessage" class="toast-message" role="status" aria-live="polite"></p>

      <input type="file" accept="image/*" capture="environment" class="hidden-input" id="takePhotoInput" />
      <input type="file" accept="image/*" class="hidden-input" id="uploadInput" />
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
      const takePhotoBtn = document.getElementById("takePhotoBtn");
      const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
      const takePhotoInput = document.getElementById("takePhotoInput");
      const uploadInput = document.getElementById("uploadInput");
      const photoLayer = document.getElementById("photoLayer");
      const photoImage = document.getElementById("photoImage");
      const placeholder = document.getElementById("placeholder");
      const whiteboardWrapper = document.getElementById("whiteboardWrapper");
      const whiteboard = document.getElementById("whiteboard");
      const captureArea = document.getElementById("captureArea");
      const boardScaleInput = document.getElementById("boardScale");
      const boardScaleValue = document.getElementById("boardScaleValue");
      const boardColorInput = document.getElementById("boardColor");
      const boardOpacityInput = document.getElementById("boardOpacity");
      const boardOpacityValue = document.getElementById("boardOpacityValue");
      const textColorInput = document.getElementById("textColor");
      const applyDataBtn = document.getElementById("applyDataBtn");
      const clearBoardBtn = document.getElementById("clearBoardBtn");
      const exportBtn = document.getElementById("exportBtn");
      const toastMessage = document.getElementById("toastMessage");

      const formInputs = {
        projectName: document.getElementById("inputProjectName"),
        inspectionLocation: document.getElementById("inputInspectionLocation"),
        testResult: document.getElementById("inputTestResult"),
        testDate: document.getElementById("inputTestDate"),
      };

      const displayTargets = {
        projectName: document.getElementById("displayProjectName"),
        inspectionLocation: document.getElementById("displayInspectionLocation"),
        testResult: document.getElementById("displayTestResult"),
        testDate: document.getElementById("displayTestDate"),
      };

      const autoResizeTextarea = (textarea) => {
        if (!textarea) return;
        textarea.style.height = "auto";
        textarea.style.height = `${Math.min(textarea.scrollHeight, 600)}px`;
      };

      const showToast = (message, variant = "info") => {
        toastMessage.textContent = message;
        toastMessage.dataset.variant = variant;
        toastMessage.classList.add("visible");
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(
          () => toastMessage.classList.remove("visible"),
          4500
        );
      };

      const updateStageAspect = () => {
        if (photoImage.hidden || !photoImage.naturalWidth) {
          captureArea.style.setProperty("--stage-aspect", "56.25%");
          return;
        }
        const ratio = (photoImage.naturalHeight / photoImage.naturalWidth) * 100;
        captureArea.style.setProperty("--stage-aspect", `${ratio}%`);
      };

      const handlePhotoFiles = (files) => {
        const [file] = files || [];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          photoImage.src = event.target.result;
          photoImage.hidden = false;
          placeholder.style.display = "none";
          updateStageAspect();
        };
        reader.readAsDataURL(file);
      };

      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

      const startDrag = (event) => {
        if (event.target.closest("input, textarea, button, select")) return;
        whiteboardWrapper.dataset.dragging = "true";
        const rect = whiteboardWrapper.getBoundingClientRect();
        whiteboardWrapper.dataset.offsetX =
          (event.clientX ?? event.touches?.[0]?.clientX ?? 0) - rect.left;
        whiteboardWrapper.dataset.offsetY =
          (event.clientY ?? event.touches?.[0]?.clientY ?? 0) - rect.top;
        whiteboardWrapper.dataset.stageRect = JSON.stringify(
          captureArea.getBoundingClientRect()
        );
      };

      const dragMove = (event) => {
        if (whiteboardWrapper.dataset.dragging !== "true") return;
        event.preventDefault();
        const stageRect = JSON.parse(whiteboardWrapper.dataset.stageRect);
        const boardRect = whiteboardWrapper.getBoundingClientRect();
        const offsetX = parseFloat(whiteboardWrapper.dataset.offsetX);
        const offsetY = parseFloat(whiteboardWrapper.dataset.offsetY);
        const pointerX = event.clientX ?? event.touches?.[0]?.clientX ?? 0;
        const pointerY = event.clientY ?? event.touches?.[0]?.clientY ?? 0;
        const newLeft = clamp(
          pointerX - stageRect.left - offsetX + boardRect.width / 2,
          boardRect.width / 2,
          stageRect.width - boardRect.width / 2
        );
        const newTop = clamp(
          pointerY - stageRect.top - offsetY + boardRect.height / 2,
          boardRect.height / 2,
          stageRect.height - boardRect.height / 2
        );
        whiteboardWrapper.style.left = `${(newLeft / stageRect.width) * 100}%`;
        whiteboardWrapper.style.top = `${(newTop / stageRect.height) * 100}%`;
      };

      const endDrag = () => {
        whiteboardWrapper.dataset.dragging = "false";
      };

      const updateBoardScale = (value) => {
        const percent = Math.max(10, Math.min(120, Number(value)));
        whiteboardWrapper.style.setProperty(
          "--board-scale",
          (percent / 100).toString()
        );
        boardScaleValue.textContent = `${percent}%`;
      };

      const toggleExportAppearance = (enable) => {
        const state = Boolean(enable);
        captureArea.classList.toggle("exporting", state);
        photoLayer.classList.toggle("exporting", state);
        whiteboard.classList.toggle("exporting", state);
      };

      const syncField = (key) => {
        const value = formInputs[key].value.trim();
        displayTargets[key].textContent = value || "—";
      };

      const syncAllFields = () => Object.keys(formInputs).forEach(syncField);

      const clearBoard = () => {
        Object.values(formInputs).forEach((input) => (input.value = ""));
        formInputs.testDate.valueAsDate = new Date();
        syncAllFields();
      };

      const updateBoardColor = (color) => {
        whiteboard.style.setProperty("--board-bg", color);
        whiteboard.style.backgroundColor = color;
      };

      const updateBoardOpacity = (percent) => {
        const value = Math.max(30, Math.min(100, Number(percent)));
        whiteboard.style.opacity = (value / 100).toString();
        boardOpacityValue.textContent = `${value}%`;
      };

      const updateTextColor = (color) => {
        whiteboard.style.color = color;
        whiteboard.querySelectorAll(".board-value, .board-notes, label").forEach((el) => {
          if (el.tagName.toLowerCase() === "label") {
            el.style.color = color;
          } else {
            el.style.color = color;
          }
        });
      };

      const toggleWhiteboardSolid = (enable) => {
        whiteboard.classList.toggle("solid-mode", Boolean(enable));
      };

      const downloadBlob = (blob, filename) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        link.click();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      };

      const openPreviewTab = (blob) => {
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      };

      const handleShareOrDownload = async (blob, filename) => {
        const file = new File([blob], filename, { type: "image/png" });
        if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
          try {
            await navigator.share({
              files: [file],
              title: "工程白板照片",
              text: "在分享面板中選擇儲存影像即可。",
            });
            showToast("已開啟分享面板，請選擇儲存影像。", "success");
            return;
          } catch (error) {
            if (error.name !== "AbortError") {
              showToast("分享面板不可用，將自動下載影像。");
            }
          }
        }
        downloadBlob(blob, filename);
        openPreviewTab(blob);
        showToast("已下載並開啟預覽，如找不到圖片請到檔案 App。", "success");
      };

      const exportBoardImage = async () => {
        exportBtn.disabled = true;
        exportBtn.textContent = "匯出中…";
        toggleExportAppearance(true);
        toggleWhiteboardSolid(true);
        try {
          const canvas = await html2canvas(captureArea, {
            backgroundColor: null,
            scale: window.devicePixelRatio || 2,
          });
          const blob = await new Promise((resolve, reject) =>
            canvas.toBlob((b) => (b ? resolve(b) : reject(new Error("failed"))), "image/png", 1)
          );
          const timestamp = new Date().toISOString().replace(/[T:]/g, "-").split(".")[0];
          await handleShareOrDownload(blob, `whiteboard_${timestamp}.png`);
        } catch (error) {
          console.error(error);
          showToast("匯出失敗，請再試一次。");
        } finally {
          toggleExportAppearance(false);
          toggleWhiteboardSolid(false);
          exportBtn.disabled = false;
          exportBtn.textContent = "匯出整張圖片";
        }
      };

      takePhotoBtn.addEventListener("click", () => takePhotoInput.click());
      uploadPhotoBtn.addEventListener("click", () => uploadInput.click());
      takePhotoInput.addEventListener("change", (event) => handlePhotoFiles(event.target.files));
      uploadInput.addEventListener("change", (event) => handlePhotoFiles(event.target.files));

      whiteboardWrapper.addEventListener("pointerdown", startDrag);
      window.addEventListener("pointermove", dragMove, { passive: false });
      window.addEventListener("pointerup", endDrag);
      window.addEventListener("pointercancel", endDrag);

      applyDataBtn.addEventListener("click", () => {
        syncAllFields();
        showToast("白板內容已更新。", "success");
      });

      clearBoardBtn.addEventListener("click", () => {
        clearBoard();
        showToast("白板文字已清除。", "success");
      });

      boardScaleInput.addEventListener("input", (event) =>
        updateBoardScale(event.target.value)
      );
      boardColorInput.addEventListener("input", (event) =>
        updateBoardColor(event.target.value)
      );
      boardOpacityInput.addEventListener("input", (event) =>
        updateBoardOpacity(event.target.value)
      );
      textColorInput.addEventListener("input", (event) =>
        updateTextColor(event.target.value)
      );

      exportBtn.addEventListener("click", exportBoardImage);
      window.addEventListener("resize", updateStageAspect);
      photoImage.addEventListener("load", updateStageAspect);

      formInputs.testDate.valueAsDate = new Date();
      syncAllFields();
      updateBoardScale(boardScaleInput.value);
      updateBoardColor(boardColorInput.value);
      updateBoardOpacity(boardOpacityInput.value);
      updateTextColor(textColorInput.value);
      autoResizeTextarea(formInputs.testResult);
      formInputs.testResult.addEventListener("input", () =>
        autoResizeTextarea(formInputs.testResult)
      );
    </script>
  </body>
</html>
