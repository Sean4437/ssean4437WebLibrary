<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>工程白板拍照工具</title>
    <style>
      :root {
        font-family: "Noto Sans TC", "Segoe UI", system-ui, -apple-system,
          BlinkMacSystemFont, sans-serif;
        line-height: 1.5;
        color: #0f172a;
        background: #0f172a;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: radial-gradient(circle, #1e293b, #0f172a);
        min-height: 100vh;
        padding: 1.25rem;
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 170px);
        display: flex;
        justify-content: center;
      }

      .app-shell {
        width: min(540px, 100%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      h1 {
        color: #f8fafc;
        text-align: center;
        margin: 0;
        font-size: clamp(1.5rem, 6vw, 2.25rem);
        letter-spacing: 0.08em;
      }

      .version-note {
        text-align: center;
        margin-top: 0.35rem;
        color: #facc15;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .data-panel {
        background: rgba(15, 23, 42, 0.4);
        border-radius: 20px;
        padding: 1rem 1.15rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        backdrop-filter: blur(12px);
        color: #e2e8f0;
      }

      .data-panel h3 {
        margin: 0 0 0.75rem;
        font-size: 1.05rem;
        letter-spacing: 0.06em;
      }

      .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 0.75rem;
      }

      .form-field {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .form-field label {
        font-size: 0.9rem;
      }

      .form-field input,
      .form-field textarea {
        border-radius: 12px;
        border: 1px solid rgba(226, 232, 240, 0.4);
        background: rgba(15, 23, 42, 0.6);
        color: #f8fafc;
        font: inherit;
        padding: 0.55rem 0.7rem;
      }

      .form-field textarea {
        min-height: 120px;
        resize: vertical;
      }

      .panel-actions {
        margin-top: 0.85rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }

      .size-control {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex: 1;
      }

      .size-control input[type="range"] {
        flex: 1;
      }

      .ghost-btn {
        border-radius: 999px;
        border: 1px solid rgba(226, 232, 240, 0.4);
        background: transparent;
        color: #e2e8f0;
        font-weight: 600;
        padding: 0.6rem 1.25rem;
        cursor: pointer;
      }

      .panel-hint {
        margin: 0.35rem 0 0;
        font-size: 0.85rem;
        color: #cbd5f5;
      }

      .signature-editor {
        margin-top: 1rem;
        background: rgba(15, 23, 42, 0.35);
        border-radius: 16px;
        padding: 0.75rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .signature-editor h4 {
        margin: 0 0 0.35rem;
        font-size: 0.95rem;
        letter-spacing: 0.05em;
      }

      .signature-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        align-items: center;
        margin-bottom: 0.4rem;
      }

      .signature-toolbar label {
        font-size: 0.85rem;
      }

      .signature-toolbar input[type="range"] {
        flex: 1;
      }

      .current-signature {
        margin-top: 0.6rem;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .signature-editor-actions {
        margin-top: 0.6rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.6rem;
        align-items: center;
      }

      .signature-editor-actions input,
      .signature-editor-actions select {
        border-radius: 999px;
        border: 1px solid rgba(226, 232, 240, 0.5);
        background: rgba(15, 23, 42, 0.5);
        color: #f8fafc;
        padding: 0.55rem 0.9rem;
        font: inherit;
      }

      .saved-signatures {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 0.75rem;
      }

      .saved-signature-card {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding: 0.45rem 0.6rem;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .saved-signature-card img {
        width: 96px;
        height: 64px;
        object-fit: contain;
        background: #fff;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 0.25rem;
      }

      .saved-signature-card button {
        border: none;
        border-radius: 999px;
        padding: 0.4rem 0.9rem;
        font-weight: 600;
        cursor: pointer;
      }

      .saved-signature-card .signature-info {
        flex: 1;
        color: #f1f5f9;
      }

      .signature-card-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: 0.35rem;
      }

      .saved-signature-card .apply-btn {
        background: linear-gradient(135deg, #34d399, #10b981);
        color: #052e13;
      }

      .saved-signature-card .delete-btn {
        background: transparent;
        border: 1px solid rgba(248, 250, 252, 0.4);
        color: #e2e8f0;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.25rem;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        box-shadow: 0 10px 18px rgba(37, 99, 235, 0.3);
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }

      .btn-secondary {
        background: transparent;
        border: 2px solid #94a3b8;
        color: #e2e8f0;
        box-shadow: none;
      }

      .stage {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 24px;
        overflow: hidden;
        background: #1f2937;
        box-shadow: 0 25px 55px rgba(0, 0, 0, 0.45);
        border: 6px solid rgba(248, 250, 252, 0.1);
      }

      .stage-content {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      .stage-content img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .stage-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #cbd5f5;
        gap: 0.35rem;
        padding: 1.5rem;
        text-align: center;
      }

      .whiteboard-wrapper {
        --board-scale: 0.85;
        position: absolute;
        left: 50%;
        top: 70%;
        transform: translate(-50%, -50%) scale(var(--board-scale));
        transform-origin: center;
        width: min(440px, 90%);
        touch-action: none;
      }

      .whiteboard-wrapper.dragging {
        opacity: 0.94;
        cursor: grabbing;
      }

      .whiteboard {
        width: 100%;
        background: rgba(248, 250, 252, 0.94);
        border-radius: 18px;
        border: 4px solid #cbd5f5;
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.35);
        padding: 0.85rem;
        backdrop-filter: blur(2px);
      }

      .whiteboard.solid-mode {
        background: #f8fafc;
      }

      .whiteboard-content {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }

      .board-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }

      .board-field {
        flex: 1;
        min-width: 180px;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }

      .board-field label {
        font-size: 0.85rem;
        letter-spacing: 0.05em;
      }

      .board-value {
        min-height: 32px;
        border: 1px solid #cbd5f5;
        border-radius: 10px;
        padding: 0.4rem 0.55rem;
        background: #fff;
        color: #0f172a;
        font-size: 0.96rem;
        font-weight: 600;
        white-space: pre-wrap;
      }

      .board-notes-area {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .board-notes {
        min-height: 250px;
        border: 1px solid #cbd5f5;
        border-radius: 14px;
        padding: 0.75rem;
        background: #fff;
        line-height: 1.45;
        font-size: 1rem;
        color: #0f172a;
        white-space: pre-wrap;
      }

      .board-footer {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: stretch;
      }

      .signature-display {
        flex: 1 1 320px;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .signature-preview-grid {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .signature-preview {
        flex: 1 1 220px;
        border: 1px dashed #94a3b8;
        border-radius: 12px;
        padding: 0.65rem;
        min-height: 160px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-preview img {
        max-width: 100%;
        max-height: 130px;
        object-fit: contain;
      }

      .signature-placeholder {
        color: #94a3b8;
        font-size: 0.9rem;
      }canvas {
        width: 100%;
        height: 180px;
        border-radius: 10px;
        border: 1px solid #cbd5f5;
        touch-action: none;
        background: #fff;
      }

      .action-bar {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
        left: 50%;
        transform: translateX(-50%);
        width: min(520px, calc(100% - 1.5rem));
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem;
        padding: 0.85rem 1rem;
        border-radius: 24px;
        background: rgba(15, 23, 42, 0.85);
        box-shadow: 0 20px 35px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(12px);
        z-index: 30;
      }

      .action-btn {
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.25rem;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.15s ease;
      }

      .action-btn.primary {
        background: linear-gradient(135deg, #059669, #10b981);
        color: #fff;
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.35);
      }

      .action-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #f8fafc;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .toast-message {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 90px);
        left: 50%;
        transform: translateX(-50%);
        width: min(520px, calc(100% - 1.5rem));
        background: rgba(15, 23, 42, 0.9);
        color: #f8fafc;
        padding: 0.75rem 1rem;
        border-radius: 16px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.45);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease;
        transform-origin: bottom;
        z-index: 25;
        text-align: center;
        font-size: 0.95rem;
      }

      .toast-message.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(-8px);
      }

      .toast-message[data-variant="success"] {
        background: rgba(34, 197, 94, 0.9);
        color: #052e13;
      }

      .hidden-input {
        display: none;
      }

      @media (max-width: 420px) {
        .board-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div>
        <h1>工程白板拍照工具</h1>
        <p class="version-note">? 已更新版本 v1.3，請使用此介面最新版功能</p>
      </div>

      <section class="data-panel">
        <h3>資料輸入面板（輸入完後套用至白板）</h3>
        <div class="data-grid">
          <div class="form-field">
            <label for="inputProjectName">工程名稱</label>
            <input
              type="text"
              id="inputProjectName"
              placeholder="例：頭屋鄉都市計畫區24M特1號道路拓寬工程"
            />
          </div>
          <div class="form-field">
            <label for="inputInspectionLocation">檢查位置</label>
            <input type="text" id="inputInspectionLocation" placeholder="輸入位置" />
          </div>
          <div class="form-field">
            <label for="inputTestDate">檢查日期</label>
            <input type="date" id="inputTestDate" />
          </div>
          <div class="form-field" style="grid-column: 1 / -1">
            <label for="inputTestResult">檢查紀錄</label>
            <textarea
              id="inputTestResult"
              placeholder="例如：OK+500~OK+590 樑段檢查，測量結果..."
            ></textarea>
          </div>
        </div>
        <div class="signature-editor">
          <h4>簽名編輯區（這裡簽名，套用後會顯示在白板）</h4>
          <div class="signature-toolbar">
            <label for="brushSize">筆刷粗細</label>
            <input type="range" id="brushSize" min="2" max="10" value="3" />
            <label for="brushColor">簽名顏色</label>
            <input type="color" id="brushColor" value="#0f172a" />
          </div>
          <canvas id="signatureCanvas"></canvas>
          <div class="current-signature">
            <label>目前簽名預覽</label>
            <div class="signature-preview">
              <span class="signature-placeholder" id="currentSignaturePlaceholder"
                >尚未簽名</span
              >
              <img id="currentSignaturePreview" alt="目前簽名" hidden />
            </div>
          </div>
          <div class="signature-editor-actions">
            <input
              type="text"
              id="signatureLabel"
              placeholder="簽名標籤（可留空）"
            />
            <select id="signatureSlot">
              <option value="slot1">套用到簽名 1</option>
              <option value="slot2">套用到簽名 2</option>
            </select>
            <button type="button" id="applySignatureBtn" class="ghost-btn">
              套用簽名
            </button>
            <button type="button" id="saveSignatureBtn" class="ghost-btn">
              儲存簽名
            </button>
          </div>
          <div class="saved-signatures" id="savedSignatures"></div>
        </div>
        <div class="panel-actions">
          <label class="size-control">
            <span>白板尺寸</span>
            <input type="range" id="boardScale" min="10" max="120" value="85" />
            <span id="boardScaleValue">85%</span>
          </label>
          <button type="button" class="ghost-btn" id="applyDataBtn">套用到白板</button>
        </div>
        <p class="panel-hint">先在此輸入，按「套用到白板」後再進行拍照或匯出。</p>
      </section>

      <div class="controls">
        <button class="btn" id="takePhotoBtn">拍照</button>
        <button class="btn btn-secondary" id="uploadPhotoBtn">上傳照片</button>
      </div>

      <div class="stage" id="captureArea">
        <div class="stage-content" id="photoLayer">
          <img id="photoImage" alt="拍攝照片預覽" hidden />
          <div class="stage-placeholder" id="placeholder">
            <strong>請拍照或上傳照片</strong>
            <span>白板會疊在照片下方區域，可拖曳調整位置與大小。</span>
          </div>
        </div>
        <div class="whiteboard-wrapper" id="whiteboardWrapper">
          <div class="whiteboard" id="whiteboard">
            <div class="whiteboard-content">
              <div class="board-row">
                <div class="board-field">
                  <label>工程名稱</label>
                  <div class="board-value" id="displayProjectName">—</div>
                </div>
                <div class="board-field">
                  <label>檢查位置</label>
                  <div class="board-value" id="displayInspectionLocation">—</div>
                </div>
              </div>
              <div class="board-notes-area">
                <label>檢查紀錄</label>
                <div class="board-notes" id="displayTestResult">—</div>
              </div>
              <div class="board-footer">
                <div class="board-field board-field--date">
                  <label>檢查日期</label>
                  <div class="board-value" id="displayTestDate">—</div>
                </div>
                <div class="signature-display">
                  <label>簽名</label>
                  <div class="signature-preview-grid">
                    <div class="signature-preview">
                      <span
                        class="signature-placeholder"
                        id="signaturePlaceholder1"
                        >簽名 1 尚未套用</span
                      >
                      <img id="signaturePreview1" alt="簽名 1" hidden />
                    </div>
                    <div class="signature-preview">
                      <span
                        class="signature-placeholder"
                        id="signaturePlaceholder2"
                        >簽名 2 尚未套用</span
                      >
                      <img id="signaturePreview2" alt="簽名 2" hidden />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="action-btn secondary" id="clearSignatureBtn">清除簽名</button>
        <button class="action-btn primary" id="exportBtn">匯出整張圖片</button>
      </div>

      <p id="toastMessage" class="toast-message" role="status" aria-live="polite"></p>

      <input
        type="file"
        accept="image/*"
        capture="environment"
        class="hidden-input"
        id="takePhotoInput"
      />
      <input type="file" accept="image/*" class="hidden-input" id="uploadInput" />
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
      const takePhotoBtn = document.getElementById("takePhotoBtn");
      const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
      const takePhotoInput = document.getElementById("takePhotoInput");
      const uploadInput = document.getElementById("uploadInput");
      const photoLayer = document.getElementById("photoLayer");
      const photoImage = document.getElementById("photoImage");
      const placeholder = document.getElementById("placeholder");
      const whiteboardWrapper = document.getElementById("whiteboardWrapper");
      const whiteboard = document.getElementById("whiteboard");
      const exportBtn = document.getElementById("exportBtn");
      const captureArea = document.getElementById("captureArea");
      const toastMessage = document.getElementById("toastMessage");
      const boardScale = document.getElementById("boardScale");
      const boardScaleValue = document.getElementById("boardScaleValue");
      const applyDataBtn = document.getElementById("applyDataBtn");

      const signatureCanvas = document.getElementById("signatureCanvas");
      const ctx = signatureCanvas.getContext("2d");
      const clearSignatureBtn = document.getElementById("clearSignatureBtn");
      const brushSize = document.getElementById("brushSize");
      const brushColor = document.getElementById("brushColor");
      const currentSignaturePreview = document.getElementById(
        "currentSignaturePreview"
      );
      const currentSignaturePlaceholder = document.getElementById(
        "currentSignaturePlaceholder"
      );
      const signatureSlotSelect = document.getElementById("signatureSlot");
      const signatureLabelInput = document.getElementById("signatureLabel");
      const applySignatureBtn = document.getElementById("applySignatureBtn");
      const saveSignatureBtn = document.getElementById("saveSignatureBtn");
      const savedSignaturesContainer =
        document.getElementById("savedSignatures");
      const signaturePreview1 = document.getElementById("signaturePreview1");
      const signaturePreview2 = document.getElementById("signaturePreview2");
      const signaturePlaceholder1 = document.getElementById(
        "signaturePlaceholder1"
      );
      const signaturePlaceholder2 = document.getElementById(
        "signaturePlaceholder2"
      );

      const formInputs = {
        projectName: document.getElementById("inputProjectName"),
        inspectionLocation: document.getElementById("inputInspectionLocation"),
        testResult: document.getElementById("inputTestResult"),
        testDate: document.getElementById("inputTestDate"),
      };

      const displayTargets = {
        projectName: document.getElementById("displayProjectName"),
        inspectionLocation: document.getElementById("displayInspectionLocation"),
        testResult: document.getElementById("displayTestResult"),
        testDate: document.getElementById("displayTestDate"),
      };

      const SIGNATURE_STORAGE_KEY = "whiteboard_saved_signatures_v1";

      const state = {
        dragging: false,
        dragOffset: { x: 0, y: 0 },
        stageRect: null,
        drawing: false,
        lastPoint: { x: 0, y: 0 },
        toastTimer: null,
        signatureEmpty: true,
        signatureSlots: { slot1: null, slot2: null },
        savedSignatures: [],
      };
      photoImage.addEventListener("load", updateStageAspect);

      const formatDateValue = (date = new Date()) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      };

      const formatExportTimestamp = () => {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hour = String(date.getHours()).padStart(2, "0");
        const minute = String(date.getMinutes()).padStart(2, "0");
        const second = String(date.getSeconds()).padStart(2, "0");
        return `${year}-${month}-${day}_${hour}-${minute}-${second}`;
      };

      const showToast = (message, variant = "info") => {
        toastMessage.textContent = message;
        toastMessage.dataset.variant = variant;
        toastMessage.classList.add("visible");
        if (state.toastTimer) clearTimeout(state.toastTimer);
        state.toastTimer = setTimeout(() => {
          toastMessage.classList.remove("visible");
        }, 4500);
      };

      const setCanvasSize = () => {
        const ratio = window.devicePixelRatio || 1;
        const { width, height } = signatureCanvas.getBoundingClientRect();
        signatureCanvas.width = width * ratio;
        signatureCanvas.height = height * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        clearSignature();
      };

      const clearSignature = () => {
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        state.signatureEmpty = true;
        updateSignaturePreview();
      };

      const getCanvasPoint = (event) => {
        const rect = signatureCanvas.getBoundingClientRect();
        const x = (event.clientX ?? event.touches?.[0]?.clientX ?? 0) - rect.left;
        const y = (event.clientY ?? event.touches?.[0]?.clientY ?? 0) - rect.top;
        return { x, y };
      };

      const startDraw = (event) => {
        state.drawing = true;
        if (state.signatureEmpty) {
          state.signatureEmpty = false;
        }
        state.lastPoint = getCanvasPoint(event);
      };

      const draw = (event) => {
        if (!state.drawing) return;
        event.preventDefault();
        const point = getCanvasPoint(event);
        ctx.strokeStyle = brushColor.value;
        ctx.lineWidth = brushSize.value;
        ctx.beginPath();
        ctx.moveTo(state.lastPoint.x, state.lastPoint.y);
        ctx.lineTo(point.x, point.y);
        ctx.stroke();
        state.lastPoint = point;
      };
      const updateSignaturePreview = () => {
        if (state.signatureEmpty) {
          currentSignaturePreview.hidden = true;
          currentSignaturePlaceholder.hidden = false;
          return;
        }
        const dataUrl = signatureCanvas.toDataURL("image/png");
        currentSignaturePreview.src = dataUrl;
        currentSignaturePreview.hidden = false;
        currentSignaturePlaceholder.hidden = true;
      };

      const stopDraw = () => {
        if (state.drawing) {
          state.drawing = false;
          updateSignaturePreview();
        }
      };

      const handleFiles = (files) => {
        const [file] = files || [];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          photoLayer.style.backgroundImage = "";
          photoImage.src = event.target.result;
          photoImage.hidden = false;
          placeholder.style.display = "none";
        };
        reader.readAsDataURL(file);
      };

      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

      const startDrag = (event) => {
        if (event.target.closest("input, textarea, button, select")) {
          return;
        }
        state.dragging = true;
        whiteboardWrapper.classList.add("dragging");
        const boardRect = whiteboardWrapper.getBoundingClientRect();
        const stageRect = captureArea.getBoundingClientRect();
        const pointerX = event.clientX ?? event.touches?.[0]?.clientX ?? 0;
        const pointerY = event.clientY ?? event.touches?.[0]?.clientY ?? 0;
        state.dragOffset.x = pointerX - boardRect.left;
        state.dragOffset.y = pointerY - boardRect.top;
        state.stageRect = stageRect;
        event.preventDefault();
      };

      const dragMove = (event) => {
        if (!state.dragging) return;
        event.preventDefault();
        const pointerX = event.clientX ?? event.touches?.[0]?.clientX ?? 0;
        const pointerY = event.clientY ?? event.touches?.[0]?.clientY ?? 0;
        const boardRect = whiteboardWrapper.getBoundingClientRect();
        const stageRect = state.stageRect;

        const newLeft = clamp(
          pointerX - stageRect.left - state.dragOffset.x + boardRect.width / 2,
          boardRect.width / 2,
          stageRect.width - boardRect.width / 2
        );
        const newTop = clamp(
          pointerY - stageRect.top - state.dragOffset.y + boardRect.height / 2,
          boardRect.height / 2,
          stageRect.height - boardRect.height / 2
        );

        whiteboardWrapper.style.left = `${(newLeft / stageRect.width) * 100}%`;
        whiteboardWrapper.style.top = `${(newTop / stageRect.height) * 100}%`;
      };

      const endDrag = () => {
        if (state.dragging) {
          state.dragging = false;
          whiteboardWrapper.classList.remove("dragging");
        }
      };

      const toggleWhiteboardSolid = (enable) => {
        whiteboard.classList.toggle("solid-mode", Boolean(enable));
      };

      const downloadBlob = (blob, filename) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        link.click();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      };

      const openPreviewTab = (blob) => {
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      };

      const handleShareOrDownload = async (blob, filename) => {
        const file = new File([blob], filename, { type: "image/png" });
        if (
          navigator.canShare &&
          navigator.canShare({ files: [file] }) &&
          navigator.share
        ) {
          try {
            await navigator.share({
              files: [file],
              title: "工程白板照片",
              text: "請在分享面板中選擇「儲存影像」即可存入相簿。",
            });
            showToast("已開啟分享面板，請選擇「儲存影像」。", "success");
            return;
          } catch (error) {
            if (error.name === "AbortError") {
              showToast("已取消分享，改為下載影像。");
            } else {
              console.warn("Share failed, fallback to download", error);
              showToast("分享面板不可用，改為下載影像。");
            }
          }
        }

        downloadBlob(blob, filename);
        openPreviewTab(blob);
        showToast("已下載並開啟預覽，如找不到圖片請至檔案 App 或長按圖片儲存。");
      };

      const syncField = (key) => {
        const value = formInputs[key].value.trim();
        displayTargets[key].textContent = value || "—";
      };

      const syncAllFields = () => {
        Object.keys(formInputs).forEach((key) => syncField(key));
      };

      const updateBoardScale = (value) => {
        const percent = Math.max(10, Math.min(120, Number(value)));
        const scale = percent / 100;
        whiteboardWrapper.style.setProperty("--board-scale", scale.toString());
        boardScaleValue.textContent = `${percent}%`;
      };

      const getCurrentSignatureDataUrl = () => {
        if (state.signatureEmpty) {
          showToast("尚未簽名，請先於簽名區簽名後再操作。");
          return null;
        }
        return signatureCanvas.toDataURL("image/png");
      };

      const applySignatureToSlot = (slot, dataUrl) => {
        const mapping = {
          slot1: {
            preview: signaturePreview1,
            placeholder: signaturePlaceholder1,
          },
          slot2: {
            preview: signaturePreview2,
            placeholder: signaturePlaceholder2,
          },
        };
        const target = mapping[slot] || mapping.slot1;
        if (!dataUrl) {
          target.preview.hidden = true;
          target.placeholder.hidden = false;
          state.signatureSlots[slot] = null;
          return;
        }
        target.preview.src = dataUrl;
        target.preview.hidden = false;
        target.placeholder.hidden = true;
        state.signatureSlots[slot] = dataUrl;
      };

      const persistSavedSignatures = () => {
        try {
          localStorage.setItem(
            SIGNATURE_STORAGE_KEY,
            JSON.stringify(state.savedSignatures)
          );
        } catch (error) {
          console.warn("無法儲存簽名清單：", error);
        }
      };

      const renderSavedSignatures = () => {
        savedSignaturesContainer.innerHTML = "";
        if (!state.savedSignatures.length) {
          savedSignaturesContainer.innerHTML =
            '<p class="panel-hint">尚未儲存簽名。</p>';
          return;
        }
        state.savedSignatures.forEach((signature) => {
          const card = document.createElement("div");
          card.className = "saved-signature-card";
          const img = document.createElement("img");
          img.src = signature.dataUrl;
          img.alt = signature.label;

          const info = document.createElement("div");
          info.className = "signature-info";
          info.innerHTML = `<strong>${signature.label}</strong>`;

          const actions = document.createElement("div");
          actions.className = "signature-card-actions";

          const applyBtn = document.createElement("button");
          applyBtn.className = "apply-btn";
          applyBtn.textContent = "套用簽名";
          applyBtn.addEventListener("click", () => {
            applySignatureToSlot(signatureSlotSelect.value, signature.dataUrl);
            showToast(`已套用簽名「${signature.label}」。`, "success");
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "刪除";
          deleteBtn.addEventListener("click", () => {
            state.savedSignatures = state.savedSignatures.filter(
              (item) => item.id !== signature.id
            );
            persistSavedSignatures();
            renderSavedSignatures();
            showToast(`已刪除簽名「${signature.label}」。`);
          });

          actions.append(applyBtn, deleteBtn);
          info.append(actions);
          card.append(img, info);
          savedSignaturesContainer.append(card);
        });
      };

      const loadSavedSignatures = () => {
        try {
          const stored = localStorage.getItem(SIGNATURE_STORAGE_KEY);
          state.savedSignatures = stored ? JSON.parse(stored) : [];
        } catch (error) {
          console.warn("讀取簽名清單失敗：", error);
          state.savedSignatures = [];
        }
        renderSavedSignatures();
      };

      const updateStageAspect = () => {
        if (
          photoImage.hidden ||
          !photoImage.naturalWidth ||
          !photoImage.naturalHeight
        ) {
          captureArea.style.aspectRatio = "";
          return;
        }
        captureArea.style.aspectRatio = `${photoImage.naturalWidth} / ${photoImage.naturalHeight}`;
      };

      const exportImage = async () => {
        exportBtn.disabled = true;
        exportBtn.textContent = "匯出中…";
        toggleWhiteboardSolid(true);
        const timestampLabel = formatExportTimestamp();
        const filename = `whiteboard_${timestampLabel}.png`;
        try {
          const canvasCapture = await html2canvas(captureArea, {
            backgroundColor: null,
            scale: window.devicePixelRatio || 2,
          });

          const blob = await new Promise((resolve, reject) => {
            canvasCapture.toBlob(
              (result) => {
                if (result) {
                  resolve(result);
                } else {
                  reject(new Error("無法生成圖片"));
                }
              },
              "image/png",
              1
            );
          });

          await handleShareOrDownload(blob, filename);
        } catch (error) {
          console.error(error);
          showToast("匯出失敗，請再試一次。");
          alert("匯出失敗，請再試一次。");
        } finally {
          toggleWhiteboardSolid(false);
          exportBtn.disabled = false;
          exportBtn.textContent = "匯出整張圖片";
        }
      };

      takePhotoBtn.addEventListener("click", () => takePhotoInput.click());
      uploadPhotoBtn.addEventListener("click", () => uploadInput.click());
      takePhotoInput.addEventListener("change", (event) =>
        handleFiles(event.target.files)
      );
      uploadInput.addEventListener("change", (event) =>
        handleFiles(event.target.files)
      );

      whiteboardWrapper.addEventListener("pointerdown", startDrag);
      window.addEventListener("pointermove", dragMove);
      window.addEventListener("pointerup", endDrag);
      window.addEventListener("pointercancel", endDrag);

      signatureCanvas.addEventListener("pointerdown", startDraw);
      signatureCanvas.addEventListener("pointermove", draw);
      window.addEventListener("pointerup", stopDraw);
      window.addEventListener("pointercancel", stopDraw);

      clearSignatureBtn.addEventListener("click", () => {
        clearSignature();
        showToast("已清除簽名，請重新簽名後再套用。");
      });
      exportBtn.addEventListener("click", exportImage);

      applyDataBtn.addEventListener("click", () => {
        syncAllFields();
        showToast("已將填寫資料套用到白板。", "success");
      });

      boardScale.addEventListener("input", (event) =>
        updateBoardScale(event.target.value)
      );

      applySignatureBtn.addEventListener("click", () => {
        const dataUrl = getCurrentSignatureDataUrl();
        if (!dataUrl) return;
        applySignatureToSlot(signatureSlotSelect.value, dataUrl);
        showToast("簽名已套用到白板。", "success");
      });

      saveSignatureBtn.addEventListener("click", () => {
        const dataUrl = getCurrentSignatureDataUrl();
        if (!dataUrl) return;
        const label =
          signatureLabelInput.value.trim() ||
          `簽名 ${state.savedSignatures.length + 1}`;
        state.savedSignatures.unshift({
          id: Date.now().toString(),
          label,
          dataUrl,
        });
        signatureLabelInput.value = "";
        persistSavedSignatures();
        renderSavedSignatures();
        showToast(`已儲存「${label}」。`, "success");
      });

      window.addEventListener("resize", setCanvasSize);

      formInputs.testDate.value = formatDateValue();
      syncAllFields();
      updateBoardScale(boardScale.value);
      setCanvasSize();
      updateSignaturePreview();
      loadSavedSignatures();
    </script>
  </body>
</html>




