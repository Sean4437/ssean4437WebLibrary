<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>工程白板拍照工具</title>
    <style>
      :root {
        --board-scale: 0.85;
        font-family: "Noto Sans TC", "Segoe UI", system-ui, -apple-system,
          BlinkMacSystemFont, sans-serif;
        line-height: 1.5;
        color: #0f172a;
        background: #0f172a;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: radial-gradient(circle, #1e293b, #0f172a);
        min-height: 100vh;
        padding: 1.25rem;
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 170px);
        display: flex;
        justify-content: center;
      }

      .app-shell {
        width: min(540px, 100%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      h1 {
        color: #f8fafc;
        text-align: center;
        margin: 0;
        font-size: clamp(1.5rem, 6vw, 2.25rem);
        letter-spacing: 0.08em;
      }

      .version-note {
        text-align: center;
        margin-top: 0.35rem;
        color: #facc15;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .data-panel {
        background: rgba(15, 23, 42, 0.4);
        border-radius: 20px;
        padding: 1rem 1.15rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        backdrop-filter: blur(12px);
        color: #e2e8f0;
      }

      .data-panel h3 {
        margin: 0 0 0.75rem;
        font-size: 1.05rem;
        letter-spacing: 0.06em;
      }

      .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 0.75rem;
      }

      .form-field {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .form-field label {
        font-size: 0.9rem;
      }

      .form-field input,
      .form-field textarea {
        border-radius: 12px;
        border: 1px solid rgba(226, 232, 240, 0.4);
        background: rgba(15, 23, 42, 0.6);
        color: #f8fafc;
        font: inherit;
        padding: 0.55rem 0.7rem;
      }

      .form-field textarea {
        min-height: 120px;
        resize: vertical;
      }

      .panel-actions {
        margin-top: 0.85rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }

      .size-control {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex: 1;
      }

      .size-control input[type="range"] {
        flex: 1;
      }

      .panel-actions .ghost-btn {
        border-radius: 999px;
        border: 1px solid rgba(226, 232, 240, 0.4);
        background: transparent;
        color: #e2e8f0;
        font-weight: 600;
        padding: 0.6rem 1.25rem;
        cursor: pointer;
      }

      .panel-hint {
        margin: 0.35rem 0 0;
        font-size: 0.85rem;
        color: #cbd5f5;
      }

      .signature-editor {
        margin-top: 1rem;
        background: rgba(15, 23, 42, 0.35);
        border-radius: 16px;
        padding: 0.75rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .signature-editor h4 {
        margin: 0 0 0.35rem;
        font-size: 0.95rem;
        letter-spacing: 0.05em;
      }

      .signature-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        align-items: center;
        margin-bottom: 0.4rem;
      }

      .signature-toolbar label {
        font-size: 0.85rem;
      }

      .signature-toolbar input[type="range"] {
        flex: 1;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.25rem;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        box-shadow: 0 10px 18px rgba(37, 99, 235, 0.3);
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }

      .btn-secondary {
        background: transparent;
        border: 2px solid #94a3b8;
        color: #e2e8f0;
        box-shadow: none;
      }

      .stage {
        position: relative;
        width: 100%;
        border-radius: 24px;
        overflow: hidden;
        background: #1f2937;
        box-shadow: 0 25px 55px rgba(0, 0, 0, 0.45);
        border: 6px solid rgba(248, 250, 252, 0.1);
      }

      .stage::before {
        content: "";
        display: block;
        width: 100%;
        padding-top: calc(16 / 9 * 100%);
      }

      .stage-content {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      .stage-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #cbd5f5;
        gap: 0.35rem;
        padding: 1.5rem;
        text-align: center;
      }

      .whiteboard {
        position: absolute;
        left: 50%;
        top: 70%;
        transform: translate(-50%, -50%) scale(var(--board-scale));
        transform-origin: center;
        width: min(440px, 90%);
        background: rgba(248, 250, 252, 0.94);
        border-radius: 18px;
        border: 4px solid #cbd5f5;
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.35);
        padding: 0.85rem;
        backdrop-filter: blur(2px);
        touch-action: none;
      }

      .whiteboard.solid-mode {
        background: #f8fafc;
      }

      .whiteboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.4rem;
        font-weight: 700;
      }

      .whiteboard-header small {
        color: #475569;
        font-weight: 500;
      }

      .board-title {
        margin-bottom: 0.4rem;
      }

      .board-title .board-value {
        font-size: 0.95rem;
        font-weight: 700;
      }

      .board-layout {
        display: grid;
        grid-template-columns: 105px 1fr;
        gap: 0.4rem;
      }

      .board-sidebar {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .board-sidebar label {
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        color: #0f172a;
      }

      .board-value {
        min-height: 28px;
        border: 1px solid #cbd5f5;
        border-radius: 10px;
        padding: 0.3rem 0.45rem;
        background: #fff;
        color: #0f172a;
        font-size: 0.9rem;
        white-space: pre-wrap;
      }

      .board-notes {
        min-height: 200px;
        border: 1px solid #cbd5f5;
        border-radius: 12px;
        padding: 0.6rem;
        background: #fff;
        line-height: 1.4;
        font-size: 0.95rem;
        color: #0f172a;
        white-space: pre-wrap;
      }

      .board-footer {
        margin-top: 0.45rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 0.45rem;
        align-items: stretch;
      }

      .signature-display {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .signature-preview {
        border: 1px dashed #94a3b8;
        border-radius: 12px;
        padding: 0.5rem;
        min-height: 140px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-preview img {
        max-width: 100%;
        max-height: 120px;
        object-fit: contain;
      }

      .signature-placeholder {
        color: #94a3b8;
        font-size: 0.9rem;
      }

      canvas {
        width: 100%;
        height: 180px;
        border-radius: 10px;
        border: 1px solid #cbd5f5;
        touch-action: none;
        background: #fff;
      }

      .action-bar {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
        left: 50%;
        transform: translateX(-50%);
        width: min(520px, calc(100% - 1.5rem));
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem;
        padding: 0.85rem 1rem;
        border-radius: 24px;
        background: rgba(15, 23, 42, 0.85);
        box-shadow: 0 20px 35px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(12px);
        z-index: 30;
      }

      .action-btn {
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.25rem;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.15s ease;
      }

      .action-btn.primary {
        background: linear-gradient(135deg, #059669, #10b981);
        color: #fff;
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.35);
      }

      .action-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #f8fafc;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .toast-message {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 90px);
        left: 50%;
        transform: translateX(-50%);
        width: min(520px, calc(100% - 1.5rem));
        background: rgba(15, 23, 42, 0.9);
        color: #f8fafc;
        padding: 0.75rem 1rem;
        border-radius: 16px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.45);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease;
        transform-origin: bottom;
        z-index: 25;
        text-align: center;
        font-size: 0.95rem;
      }

      .toast-message.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(-8px);
      }

      .toast-message[data-variant="success"] {
        background: rgba(34, 197, 94, 0.9);
        color: #052e13;
      }

      .hidden-input {
        display: none;
      }

      @media (max-width: 420px) {
        .board-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div>
        <h1>工程白板拍照工具</h1>
        <p class="version-note">⚠ 已更新版本 v1.2，請使用此介面最新版功能</p>
      </div>

      <section class="data-panel">
        <h3>資料輸入面板（輸入完後套用至白板）</h3>
        <div class="data-grid">
          <div class="form-field">
            <label for="inputProjectName">工程名稱</label>
            <input
              type="text"
              id="inputProjectName"
              placeholder="例：頭屋鄉都市計畫區24M特1號道路拓寬工程"
            />
          </div>
          <div class="form-field">
            <label for="inputInspectionLocation">檢查位置</label>
            <input type="text" id="inputInspectionLocation" placeholder="輸入位置" />
          </div>
          <div class="form-field">
            <label for="inputDesignSpec">設計規範</label>
            <input type="text" id="inputDesignSpec" placeholder="輸入規範" />
          </div>
          <div class="form-field">
            <label for="inputTestItem">試驗項目</label>
            <input type="text" id="inputTestItem" placeholder="輸入試驗項目" />
          </div>
          <div class="form-field">
            <label for="inputTestDate">檢查日期</label>
            <input type="date" id="inputTestDate" />
          </div>
          <div class="form-field">
            <label for="inputInspector">檢查人員</label>
            <input type="text" id="inputInspector" placeholder="輸入檢查人員" />
          </div>
          <div class="form-field" style="grid-column: 1 / -1">
            <label for="inputTestResult">檢查紀錄/備註</label>
            <textarea
              id="inputTestResult"
              placeholder="例如：OK+500~OK+590 撓工梁 接桿規定 W=105cm…"
            ></textarea>
          </div>
        </div>
        <div class="signature-editor">
          <h4>簽名編輯區（這裡簽名，套用後會顯示在白板）</h4>
          <div class="signature-toolbar">
            <label for="brushSize">筆刷粗細</label>
            <input type="range" id="brushSize" min="2" max="10" value="3" />
            <label for="brushColor">簽名顏色</label>
            <input type="color" id="brushColor" value="#0f172a" />
          </div>
          <canvas id="signatureCanvas"></canvas>
        </div>
        <div class="panel-actions">
          <label class="size-control">
            <span>白板尺寸</span>
            <input type="range" id="boardScale" min="10" max="120" value="85" />
            <span id="boardScaleValue">85%</span>
          </label>
          <button type="button" class="ghost-btn" id="applyDataBtn">套用到白板</button>
        </div>
        <p class="panel-hint">先在此輸入，按「套用到白板」後再進行拍照或匯出。</p>
      </section>

      <div class="controls">
        <button class="btn" id="takePhotoBtn">拍照</button>
        <button class="btn btn-secondary" id="uploadPhotoBtn">上傳照片</button>
      </div>

      <div class="stage" id="captureArea">
        <div class="stage-content" id="photoLayer">
          <div class="stage-placeholder" id="placeholder">
            <strong>請拍照或上傳照片</strong>
            <span>白板會疊在照片下方區域，可拖曳調整位置與大小。</span>
          </div>
        </div>
        <div class="whiteboard" id="whiteboard">
          <div class="whiteboard-header">
            <h2>現場試驗紀錄板</h2>
            <small>拖曳白板可移動位置</small>
          </div>
          <div class="board-title">
            <label>工程名稱</label>
            <div class="board-value" id="displayProjectName">（尚未輸入）</div>
          </div>
          <div class="board-layout">
            <div class="board-sidebar">
              <label>
                檢查位置
                <div class="board-value" id="displayInspectionLocation">—</div>
              </label>
              <label>
                設計規範
                <div class="board-value" id="displayDesignSpec">—</div>
              </label>
              <label>
                試驗項目
                <div class="board-value" id="displayTestItem">—</div>
              </label>
            </div>
            <div class="board-main">
              <label>檢查紀錄</label>
              <div class="board-notes" id="displayTestResult">—</div>
            </div>
          </div>
          <div class="board-footer">
            <div class="form-field">
              <label>檢查日期</label>
              <div class="board-value" id="displayTestDate">—</div>
            </div>
            <div class="form-field">
              <label>檢查人員</label>
              <div class="board-value" id="displayInspector">—</div>
            </div>
            <div class="signature-display">
              <label>簽名</label>
              <div class="signature-preview">
                <span class="signature-placeholder" id="signaturePlaceholder"
                  >尚未簽名</span
                >
                <img id="signaturePreview" alt="簽名預覽" hidden />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="action-btn secondary" id="clearSignatureBtn">清除簽名</button>
        <button class="action-btn primary" id="exportBtn">匯出整張圖片</button>
      </div>

      <p id="toastMessage" class="toast-message" role="status" aria-live="polite"></p>

      <input
        type="file"
        accept="image/*"
        capture="environment"
        class="hidden-input"
        id="takePhotoInput"
      />
      <input type="file" accept="image/*" class="hidden-input" id="uploadInput" />
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
      const takePhotoBtn = document.getElementById("takePhotoBtn");
      const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
      const takePhotoInput = document.getElementById("takePhotoInput");
      const uploadInput = document.getElementById("uploadInput");
      const photoLayer = document.getElementById("photoLayer");
      const placeholder = document.getElementById("placeholder");
      const whiteboard = document.getElementById("whiteboard");
      const exportBtn = document.getElementById("exportBtn");
      const captureArea = document.getElementById("captureArea");
      const toastMessage = document.getElementById("toastMessage");
      const boardScale = document.getElementById("boardScale");
      const boardScaleValue = document.getElementById("boardScaleValue");
      const applyDataBtn = document.getElementById("applyDataBtn");

      const signatureCanvas = document.getElementById("signatureCanvas");
      const ctx = signatureCanvas.getContext("2d");
      const clearSignatureBtn = document.getElementById("clearSignatureBtn");
      const brushSize = document.getElementById("brushSize");
      const brushColor = document.getElementById("brushColor");
      const signaturePreview = document.getElementById("signaturePreview");
      const signaturePlaceholder = document.getElementById("signaturePlaceholder");

      const formInputs = {
        projectName: document.getElementById("inputProjectName"),
        inspectionLocation: document.getElementById("inputInspectionLocation"),
        designSpec: document.getElementById("inputDesignSpec"),
        testItem: document.getElementById("inputTestItem"),
        testResult: document.getElementById("inputTestResult"),
        testDate: document.getElementById("inputTestDate"),
        inspector: document.getElementById("inputInspector"),
      };

      const displayTargets = {
        projectName: document.getElementById("displayProjectName"),
        inspectionLocation: document.getElementById("displayInspectionLocation"),
        designSpec: document.getElementById("displayDesignSpec"),
        testItem: document.getElementById("displayTestItem"),
        testResult: document.getElementById("displayTestResult"),
        testDate: document.getElementById("displayTestDate"),
        inspector: document.getElementById("displayInspector"),
      };

      const state = {
        dragging: false,
        dragOffset: { x: 0, y: 0 },
        stageRect: null,
        drawing: false,
        lastPoint: { x: 0, y: 0 },
        toastTimer: null,
        signatureEmpty: true,
      };

      const formatDateValue = (date = new Date()) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      };

      const formatExportTimestamp = () => {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hour = String(date.getHours()).padStart(2, "0");
        const minute = String(date.getMinutes()).padStart(2, "0");
        const second = String(date.getSeconds()).padStart(2, "0");
        return `${year}-${month}-${day}_${hour}-${minute}-${second}`;
      };

      const showToast = (message, variant = "info") => {
        toastMessage.textContent = message;
        toastMessage.dataset.variant = variant;
        toastMessage.classList.add("visible");
        if (state.toastTimer) clearTimeout(state.toastTimer);
        state.toastTimer = setTimeout(() => {
          toastMessage.classList.remove("visible");
        }, 4500);
      };

      const setCanvasSize = () => {
        const ratio = window.devicePixelRatio || 1;
        const { width, height } = signatureCanvas.getBoundingClientRect();
        signatureCanvas.width = width * ratio;
        signatureCanvas.height = height * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        clearSignature();
      };

      const clearSignature = () => {
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        state.signatureEmpty = true;
        updateSignaturePreview();
      };

      const getCanvasPoint = (event) => {
        const rect = signatureCanvas.getBoundingClientRect();
        const x = (event.clientX ?? event.touches?.[0]?.clientX ?? 0) - rect.left;
        const y = (event.clientY ?? event.touches?.[0]?.clientY ?? 0) - rect.top;
        return { x, y };
      };

      const startDraw = (event) => {
        state.drawing = true;
        if (state.signatureEmpty) {
          state.signatureEmpty = false;
        }
        state.lastPoint = getCanvasPoint(event);
      };

      const draw = (event) => {
        if (!state.drawing) return;
        event.preventDefault();
        const point = getCanvasPoint(event);
        ctx.strokeStyle = brushColor.value;
        ctx.lineWidth = brushSize.value;
        ctx.beginPath();
        ctx.moveTo(state.lastPoint.x, state.lastPoint.y);
        ctx.lineTo(point.x, point.y);
        ctx.stroke();
        state.lastPoint = point;
      };
      const updateSignaturePreview = () => {
        if (state.signatureEmpty) {
          signaturePreview.hidden = true;
          signaturePlaceholder.hidden = false;
          return;
        }
        const dataUrl = signatureCanvas.toDataURL("image/png");
        signaturePreview.src = dataUrl;
        signaturePreview.hidden = false;
        signaturePlaceholder.hidden = true;
      };

      const stopDraw = () => {
        if (state.drawing) {
          state.drawing = false;
          updateSignaturePreview();
        }
      };

      const handleFiles = (files) => {
        const [file] = files || [];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          photoLayer.style.backgroundImage = `url(${event.target.result})`;
          placeholder.style.display = "none";
        };
        reader.readAsDataURL(file);
      };

      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

      const startDrag = (event) => {
        if (event.target.closest("input, textarea, button, select")) {
          return;
        }
        state.dragging = true;
        whiteboard.classList.add("dragging");
        const boardRect = whiteboard.getBoundingClientRect();
        const stageRect = captureArea.getBoundingClientRect();
        const pointerX = event.clientX ?? event.touches?.[0]?.clientX ?? 0;
        const pointerY = event.clientY ?? event.touches?.[0]?.clientY ?? 0;
        state.dragOffset.x = pointerX - boardRect.left;
        state.dragOffset.y = pointerY - boardRect.top;
        state.stageRect = stageRect;
        event.preventDefault();
      };

      const dragMove = (event) => {
        if (!state.dragging) return;
        event.preventDefault();
        const pointerX = event.clientX ?? event.touches?.[0]?.clientX ?? 0;
        const pointerY = event.clientY ?? event.touches?.[0]?.clientY ?? 0;
        const boardRect = whiteboard.getBoundingClientRect();
        const stageRect = state.stageRect;

        const newLeft = clamp(
          pointerX - stageRect.left - state.dragOffset.x + boardRect.width / 2,
          boardRect.width / 2,
          stageRect.width - boardRect.width / 2
        );
        const newTop = clamp(
          pointerY - stageRect.top - state.dragOffset.y + boardRect.height / 2,
          boardRect.height / 2,
          stageRect.height - boardRect.height / 2
        );

        whiteboard.style.left = `${(newLeft / stageRect.width) * 100}%`;
        whiteboard.style.top = `${(newTop / stageRect.height) * 100}%`;
        whiteboard.style.transform = "translate(-50%, -50%)";
      };

      const endDrag = () => {
        if (state.dragging) {
          state.dragging = false;
          whiteboard.classList.remove("dragging");
        }
      };

      const toggleWhiteboardSolid = (enable) => {
        whiteboard.classList.toggle("solid-mode", Boolean(enable));
      };

      const downloadBlob = (blob, filename) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        link.click();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      };

      const openPreviewTab = (blob) => {
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      };

      const handleShareOrDownload = async (blob, filename) => {
        const file = new File([blob], filename, { type: "image/png" });
        if (
          navigator.canShare &&
          navigator.canShare({ files: [file] }) &&
          navigator.share
        ) {
          try {
            await navigator.share({
              files: [file],
              title: "工程白板照片",
              text: "請在分享面板中選擇「儲存影像」即可存入相簿。",
            });
            showToast("已開啟分享面板，請選擇「儲存影像」。", "success");
            return;
          } catch (error) {
            if (error.name === "AbortError") {
              showToast("已取消分享，改為下載影像。");
            } else {
              console.warn("Share failed, fallback to download", error);
              showToast("分享面板不可用，改為下載影像。");
            }
          }
        }

        downloadBlob(blob, filename);
        openPreviewTab(blob);
        showToast("已下載並開啟預覽，如找不到圖片請至檔案 App 或長按圖片儲存。");
      };

      const syncField = (key) => {
        const value = formInputs[key].value.trim();
        displayTargets[key].textContent = value || "—";
      };

      const syncAllFields = () => {
        Object.keys(formInputs).forEach((key) => syncField(key));
      };

      const updateBoardScale = (value) => {
        const percent = Math.max(10, Math.min(120, Number(value)));
        const scale = percent / 100;
        document.documentElement.style.setProperty(
          "--board-scale",
          scale.toString()
        );
        boardScaleValue.textContent = `${percent}%`;
      };

      const exportImage = async () => {
        exportBtn.disabled = true;
        exportBtn.textContent = "匯出中…";
        toggleWhiteboardSolid(true);
        const timestampLabel = formatExportTimestamp();
        const filename = `whiteboard_${timestampLabel}.png`;
        try {
          const canvasCapture = await html2canvas(captureArea, {
            backgroundColor: null,
            scale: window.devicePixelRatio || 2,
          });

          const blob = await new Promise((resolve, reject) => {
            canvasCapture.toBlob(
              (result) => {
                if (result) {
                  resolve(result);
                } else {
                  reject(new Error("無法生成圖片"));
                }
              },
              "image/png",
              1
            );
          });

          await handleShareOrDownload(blob, filename);
        } catch (error) {
          console.error(error);
          showToast("匯出失敗，請再試一次。");
          alert("匯出失敗，請再試一次。");
        } finally {
          toggleWhiteboardSolid(false);
          exportBtn.disabled = false;
          exportBtn.textContent = "匯出整張圖片";
        }
      };

      takePhotoBtn.addEventListener("click", () => takePhotoInput.click());
      uploadPhotoBtn.addEventListener("click", () => uploadInput.click());
      takePhotoInput.addEventListener("change", (event) =>
        handleFiles(event.target.files)
      );
      uploadInput.addEventListener("change", (event) =>
        handleFiles(event.target.files)
      );

      whiteboard.addEventListener("pointerdown", startDrag);
      window.addEventListener("pointermove", dragMove);
      window.addEventListener("pointerup", endDrag);
      window.addEventListener("pointercancel", endDrag);

      signatureCanvas.addEventListener("pointerdown", startDraw);
      signatureCanvas.addEventListener("pointermove", draw);
      window.addEventListener("pointerup", stopDraw);
      window.addEventListener("pointercancel", stopDraw);

      clearSignatureBtn.addEventListener("click", () => {
        clearSignature();
        showToast("已清除簽名，請重新簽名後再套用。");
      });
      exportBtn.addEventListener("click", exportImage);

      applyDataBtn.addEventListener("click", () => {
        syncAllFields();
        updateSignaturePreview();
        showToast("已將填寫與簽名套用到白板。", "success");
      });

      boardScale.addEventListener("input", (event) =>
        updateBoardScale(event.target.value)
      );

      window.addEventListener("resize", setCanvasSize);

      formInputs.testDate.value = formatDateValue();
      syncAllFields();
      updateBoardScale(boardScale.value);
      setCanvasSize();
      updateSignaturePreview();
    </script>
  </body>
</html>
